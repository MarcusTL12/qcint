#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include "simd.h"
#include "rys_roots.h"

/*
from mpmath import *
mp.dps = 25
for i in range(14):
    for j in range(14):
        print('   %.19e' % cos(pi*j*(2*i+1)/28)[-26:])
*/
static const double COS_14_14[] = {
 1.                       ,
 9.9371220989324260398e-01,
 9.7492791218182361934e-01,
 9.4388333030836757409e-01,
 9.0096886790241914600e-01,
 8.4672419922828412453e-01,
 7.8183148246802980363e-01,
 7.0710678118654757274e-01,
 6.2348980185873348336e-01,
 5.3203207651533657163e-01,
 4.3388373911755812040e-01,
 3.3027906195516709698e-01,
 2.2252093395631439288e-01,
 1.1196447610330785560e-01,
 1.                       ,
 9.4388333030836757409e-01,
 7.8183148246802980363e-01,
 5.3203207651533657163e-01,
 2.2252093395631439288e-01,
-1.1196447610330785560e-01,
-4.3388373911755812040e-01,
-7.0710678118654757274e-01,
-9.0096886790241914600e-01,
-9.9371220989324260398e-01,
-9.7492791218182361934e-01,
-8.4672419922828412453e-01,
-6.2348980185873348336e-01,
-3.3027906195516709698e-01,
 1.                       ,
 8.4672419922828412453e-01,
 4.3388373911755812040e-01,
-1.1196447610330785560e-01,
-6.2348980185873348336e-01,
-9.4388333030836757409e-01,
-9.7492791218182361934e-01,
-7.0710678118654757274e-01,
-2.2252093395631439288e-01,
 3.3027906195516709698e-01,
 7.8183148246802980363e-01,
 9.9371220989324260398e-01,
 9.0096886790241914600e-01,
 5.3203207651533657163e-01,
 1.                       ,
 7.0710678118654757274e-01,
 0.                       ,
-7.0710678118654757274e-01,
-1.                       ,
-7.0710678118654757274e-01,
 0.                       ,
 7.0710678118654757274e-01,
 1.                       ,
 7.0710678118654757274e-01,
 0.                       ,
-7.0710678118654757274e-01,
-1.                       ,
-7.0710678118654757274e-01,
 1.                       ,
 5.3203207651533657163e-01,
-4.3388373911755812040e-01,
-9.9371220989324260398e-01,
-6.2348980185873348336e-01,
 3.3027906195516709698e-01,
 9.7492791218182361934e-01,
 7.0710678118654757274e-01,
-2.2252093395631439288e-01,
-9.4388333030836757409e-01,
-7.8183148246802980363e-01,
 1.1196447610330785560e-01,
 9.0096886790241914600e-01,
 8.4672419922828412453e-01,
 1.                       ,
 3.3027906195516709698e-01,
-7.8183148246802980363e-01,
-8.4672419922828412453e-01,
 2.2252093395631439288e-01,
 9.9371220989324260398e-01,
 4.3388373911755812040e-01,
-7.0710678118654757274e-01,
-9.0096886790241914600e-01,
 1.1196447610330785560e-01,
 9.7492791218182361934e-01,
 5.3203207651533657163e-01,
-6.2348980185873348336e-01,
-9.4388333030836757409e-01,
 1.                       ,
 1.1196447610330785560e-01,
-9.7492791218182361934e-01,
-3.3027906195516709698e-01,
 9.0096886790241914600e-01,
 5.3203207651533657163e-01,
-7.8183148246802980363e-01,
-7.0710678118654757274e-01,
 6.2348980185873348336e-01,
 8.4672419922828412453e-01,
-4.3388373911755812040e-01,
-9.4388333030836757409e-01,
 2.2252093395631439288e-01,
 9.9371220989324260398e-01,
 1.                       ,
-1.1196447610330785560e-01,
-9.7492791218182361934e-01,
 3.3027906195516709698e-01,
 9.0096886790241914600e-01,
-5.3203207651533657163e-01,
-7.8183148246802980363e-01,
 7.0710678118654757274e-01,
 6.2348980185873348336e-01,
-8.4672419922828412453e-01,
-4.3388373911755812040e-01,
 9.4388333030836757409e-01,
 2.2252093395631439288e-01,
-9.9371220989324260398e-01,
 1.                       ,
-3.3027906195516709698e-01,
-7.8183148246802980363e-01,
 8.4672419922828412453e-01,
 2.2252093395631439288e-01,
-9.9371220989324260398e-01,
 4.3388373911755812040e-01,
 7.0710678118654757274e-01,
-9.0096886790241914600e-01,
-1.1196447610330785560e-01,
 9.7492791218182361934e-01,
-5.3203207651533657163e-01,
-6.2348980185873348336e-01,
 9.4388333030836757409e-01,
 1.                       ,
-5.3203207651533657163e-01,
-4.3388373911755812040e-01,
 9.9371220989324260398e-01,
-6.2348980185873348336e-01,
-3.3027906195516709698e-01,
 9.7492791218182361934e-01,
-7.0710678118654757274e-01,
-2.2252093395631439288e-01,
 9.4388333030836757409e-01,
-7.8183148246802980363e-01,
-1.1196447610330785560e-01,
 9.0096886790241914600e-01,
-8.4672419922828412453e-01,
 1.                       ,
-7.0710678118654757274e-01,
 0.                       ,
 7.0710678118654757274e-01,
-1.                       ,
 7.0710678118654757274e-01,
 0.                       ,
-7.0710678118654757274e-01,
 1.                       ,
-7.0710678118654757274e-01,
 0.                       ,
 7.0710678118654757274e-01,
-1.                       ,
 7.0710678118654757274e-01,
 1.                       ,
-8.4672419922828412453e-01,
 4.3388373911755812040e-01,
 1.1196447610330785560e-01,
-6.2348980185873348336e-01,
 9.4388333030836757409e-01,
-9.7492791218182361934e-01,
 7.0710678118654757274e-01,
-2.2252093395631439288e-01,
-3.3027906195516709698e-01,
 7.8183148246802980363e-01,
-9.9371220989324260398e-01,
 9.0096886790241914600e-01,
-5.3203207651533657163e-01,
 1.                       ,
-9.4388333030836757409e-01,
 7.8183148246802980363e-01,
-5.3203207651533657163e-01,
 2.2252093395631439288e-01,
 1.1196447610330785560e-01,
-4.3388373911755812040e-01,
 7.0710678118654757274e-01,
-9.0096886790241914600e-01,
 9.9371220989324260398e-01,
-9.7492791218182361934e-01,
 8.4672419922828412453e-01,
-6.2348980185873348336e-01,
 3.3027906195516709698e-01,
 1.                       ,
-9.9371220989324260398e-01,
 9.7492791218182361934e-01,
-9.4388333030836757409e-01,
 9.0096886790241914600e-01,
-8.4672419922828412453e-01,
 7.8183148246802980363e-01,
-7.0710678118654757274e-01,
 6.2348980185873348336e-01,
-5.3203207651533657163e-01,
 4.3388373911755812040e-01,
-3.3027906195516709698e-01,
 2.2252093395631439288e-01,
-1.1196447610330785560e-01,
0,
0,
};

void _CINT_clenshaw_dc(double *rr, const double *x, double u, int nroots)
{
#if (SIMDD == 8)
        int i, k;
        __m512d d0, d1;
        __m512d g0, g1;
        __m512d u1 = MM_SET1(u);
        __m512d u2 = MM_SET1(u * 2.);
        __m512d half = MM_SET1(0.5);
        for (i = 0; i < nroots; ++i) {
                //for (j = 0; j < 14; j++) {
                //        d[j] = 0;
                //        g[j] = x[13*14+j];
                //}
                d0 =  MM_SET1(0.);
                d1 =  MM_SET1(0.);
                g0 =  MM_LOADU(x+13*14);
                g1 =  MM_LOADU(x+13*14+SIMDD);
                for (k = 11; k >= 1; k-=2) {
                        //for (j = 0; j < 14; j++) {
                        //        d[j] = u2 * g[j] - d[j] + x[(k+1)*14+j ];
                        //}
                        d0 =  u2 * g0 - d0 + MM_LOADU(x+(k+1)*14      );
                        d1 =  u2 * g1 - d1 + MM_LOADU(x+(k+1)*14+SIMDD);
                        //for (j = 0; j < 14; j++){
                        //        g[j] = u2 * d[j] - g[j] + x[k*14+j];
                        //}
                        g0 =  u2 * d0 - g0 + MM_LOADU(x+k*14      );
                        g1 =  u2 * d1 - g1 + MM_LOADU(x+k*14+SIMDD);
                }
                //for (j = 0; j < 14; j++) {
                //        rr[j+14*i] = u * g[j] - d[j] + x[j] * 0.5;
                //}
                MM_STOREU(rr+14*i      , MM_SET1(u) * g0 - d0 + MM_LOADU(x      ) * half);
                MM_STOREU(rr+14*i+SIMDD, MM_SET1(u) * g1 - d1 + MM_LOADU(x+SIMDD) * half);
                x += 196;
        }
#elif (SIMDD == 4)
        int i, k;
        __m256d d0, d1, d2, d3;
        __m256d g0, g1, g2, g3;
        __m256d u1 = MM_SET1(u);
        __m256d u2 = MM_SET1(u * 2.);
        __m256d half = MM_SET1(0.5);
        for (i = 0; i < nroots; ++i) {
                //for (j = 0; j < 14; j++) {
                //        d[j] = 0;
                //        g[j] = x[13*14+j];
                //}
                d0 =  MM_SET1(0.);
                d1 =  MM_SET1(0.);
                d2 =  MM_SET1(0.);
                d3 =  MM_SET1(0.);
                g0 =  MM_LOADU(x+13*14        );
                g1 =  MM_LOADU(x+13*14+SIMDD  );
                g2 =  MM_LOADU(x+13*14+SIMDD*2);
                g3 =  MM_LOADU(x+13*14+SIMDD*3);
                for (k = 11; k >= 1; k-=2) {
                        //for (j = 0; j < 14; j++) {
                        //        d[j] = u2 * g[j] - d[j] + x[(k+1)*14+j ];
                        //}
                        d0 =  u2 * g0 - d0 + MM_LOADU(x+(k+1)*14        );
                        d1 =  u2 * g1 - d1 + MM_LOADU(x+(k+1)*14+SIMDD  );
                        d2 =  u2 * g2 - d2 + MM_LOADU(x+(k+1)*14+SIMDD*2);
                        d3 =  u2 * g3 - d3 + MM_LOADU(x+(k+1)*14+SIMDD*3);
                        //for (j = 0; j < 14; j++){
                        //        g[j] = u2 * d[j] - g[j] + x[k*14+j];
                        //}
                        g0 =  u2 * d0 - g0 + MM_LOADU(x+k*14        );
                        g1 =  u2 * d1 - g1 + MM_LOADU(x+k*14+SIMDD  );
                        g2 =  u2 * d2 - g2 + MM_LOADU(x+k*14+SIMDD*2);
                        g3 =  u2 * d3 - g3 + MM_LOADU(x+k*14+SIMDD*3);
                }
                //for (j = 0; j < 14; j++) {
                //        rr[j+14*i] = u * g[j] - d[j] + x[j] * 0.5;
                //}
                MM_STOREU(rr+14*i        , u1 * g0 - d0 + MM_LOADU(x        ) * half);
                MM_STOREU(rr+14*i+SIMDD  , u1 * g1 - d1 + MM_LOADU(x+SIMDD  ) * half);
                MM_STOREU(rr+14*i+SIMDD*2, u1 * g1 - d1 + MM_LOADU(x+SIMDD*2) * half);
                MM_STOREU(rr+14*i+SIMDD*3, u1 * g1 - d1 + MM_LOADU(x+SIMDD*3) * half);
                x += 196;
        }
#else
        int i, j, k;
        __m128d d[7];
        __m128d g[7];
        __m128d u1 = MM_SET1(u);
        __m128d u2 = MM_SET1(u * 2.);
        __m128d half = MM_SET1(0.5);
        for (i = 0; i < nroots; ++i) {
                for (j = 0; j < 14/SIMDD; j++) {
                        d[j] = MM_SET1(0);
                        g[j] = MM_LOAD(x+13*14+j*SIMDD);
                }
                for (k = 11; k >= 1; k-=2) {
                        for (j = 0; j < 14/SIMDD; j++) {
                                d[j] = u2 * g[j] - d[j] + MM_LOAD(x+(k+1)*14+j*SIMDD);
                        }
                        for (j = 0; j < 14/SIMDD; j++){
                                g[j] = u2 * d[j] - g[j] + MM_LOAD(x+k*14+j*SIMDD);
                        }
                }
                for (j = 0; j < 14/SIMDD; j++) {
                        MM_STORE(rr+14*i+j*SIMDD, u1 * g[j] - d[j] + x[j] * half);
                }
                x += 196;
        }
#endif
}

void _CINT_clenshaw_d1(double *rr, const double *x, double u, int nroots)
{
        int i;
        double d0, d1, g0, g1;
        double u2 = u * 2.;

        for (i = 0; i < nroots-1; i+=2) {
                d0 = 0;
                d1 = 0;
                g0 = x[13+   14*i];
                g1 = x[13+14+14*i];
                d0 = u2 * g0 - d0 + x[12+   14*i];
                d1 = u2 * g1 - d1 + x[12+14+14*i];
                g0 = u2 * d0 - g0 + x[11+   14*i];
                g1 = u2 * d1 - g1 + x[11+14+14*i];
                d0 = u2 * g0 - d0 + x[10+   14*i];
                d1 = u2 * g1 - d1 + x[10+14+14*i];
                g0 = u2 * d0 - g0 + x[9 +   14*i];
                g1 = u2 * d1 - g1 + x[9 +14+14*i];
                d0 = u2 * g0 - d0 + x[8 +   14*i];
                d1 = u2 * g1 - d1 + x[8 +14+14*i];
                g0 = u2 * d0 - g0 + x[7 +   14*i];
                g1 = u2 * d1 - g1 + x[7 +14+14*i];
                d0 = u2 * g0 - d0 + x[6 +   14*i];
                d1 = u2 * g1 - d1 + x[6 +14+14*i];
                g0 = u2 * d0 - g0 + x[5 +   14*i];
                g1 = u2 * d1 - g1 + x[5 +14+14*i];
                d0 = u2 * g0 - d0 + x[4 +   14*i];
                d1 = u2 * g1 - d1 + x[4 +14+14*i];
                g0 = u2 * d0 - g0 + x[3 +   14*i];
                g1 = u2 * d1 - g1 + x[3 +14+14*i];
                d0 = u2 * g0 - d0 + x[2 +   14*i];
                d1 = u2 * g1 - d1 + x[2 +14+14*i];
                g0 = u2 * d0 - g0 + x[1 +   14*i];
                g1 = u2 * d1 - g1 + x[1 +14+14*i];
                rr[i    *SIMDD] = u * g0 - d0 + x[14*i   ] * 0.5;
                rr[(i+1)*SIMDD] = u * g1 - d1 + x[14*i+14] * 0.5;
        }
        if (i < nroots) {
                d0 = 0;
                g0 = x[13+14*i];
                d0 = u2 * g0 - d0 + x[12+14*i];
                g0 = u2 * d0 - g0 + x[11+14*i];
                d0 = u2 * g0 - d0 + x[10+14*i];
                g0 = u2 * d0 - g0 + x[9 +14*i];
                d0 = u2 * g0 - d0 + x[8 +14*i];
                g0 = u2 * d0 - g0 + x[7 +14*i];
                d0 = u2 * g0 - d0 + x[6 +14*i];
                g0 = u2 * d0 - g0 + x[5 +14*i];
                d0 = u2 * g0 - d0 + x[4 +14*i];
                g0 = u2 * d0 - g0 + x[3 +14*i];
                d0 = u2 * g0 - d0 + x[2 +14*i];
                g0 = u2 * d0 - g0 + x[1 +14*i];
                rr[i*SIMDD] = u * g0 - d0 + x[14*i] * 0.5;
        }
}

void _CINT_matmul_14_14(double *imc, double *im, int nroots)
{
#if (SIMDD == 8)
        int i, j;
        __m512d o7 = MM_SET1(0.14285714285714285714);
        __m512d s;
        __m512d d0, d1;
        for (i = 0; i < nroots; i++) {
                //for (j = 0; j < 14; j++) {
                //        d0[j] = 0;
                //}
                d0 =  MM_SET1(0.);
                d1 =  MM_SET1(0.);
                for (j = 0; j < 14; j++) {
                        s = MM_SET1(im[j+14*i]);
                        //for (k = 0; k < 14; ++k) {
                        //        d0[k] += s * COS_14_14[j*14+k];
                        //}
                        d0 = d0 + s * MM_LOADU(COS_14_14+j*14      );
                        d1 = d1 + s * MM_LOADU(COS_14_14+j*14+SIMDD);
                }
                //for (j = 0; j < 14; j++) {
                //        imc[j+14*i] = o7 * d0[j];
                //}
                MM_STOREU(imc+14*i      , o7 * d0);
                MM_STOREU(imc+14*i+SIMDD, o7 * d1);
                // TODO: wait MM_STOREU finished before next assignment
        }
#elif (SIMDD == 4)
        int i, j;
        __m256d o7 = MM_SET1(0.14285714285714285714);
        __m256d s;
        __m256d d0, d1, d2, d3;
        for (i = 0; i < nroots; i++) {
                //for (j = 0; j < 14; j++) {
                //        d0[j] = 0;
                //}
                d0 =  MM_SET1(0.);
                d1 =  MM_SET1(0.);
                d2 =  MM_SET1(0.);
                d3 =  MM_SET1(0.);
                for (j = 0; j < 14; j++) {
                        s = MM_SET1(im[j+14*i]);
                        //for (k = 0; k < 14; ++k) {
                        //        d0[k] += s * COS_14_14[j*14+k];
                        //}
                        d0 = d0 + s * MM_LOADU(COS_14_14+j*14        );
                        d1 = d1 + s * MM_LOADU(COS_14_14+j*14+SIMDD  );
                        d2 = d2 + s * MM_LOADU(COS_14_14+j*14+SIMDD*2);
                        d3 = d3 + s * MM_LOADU(COS_14_14+j*14+SIMDD*3);
                }
                //for (j = 0; j < 14; j++) {
                //        imc[j+14*i] = o7 * d0[j];
                //}
                MM_STOREU(imc+14*i        , o7 * d0);
                MM_STOREU(imc+14*i+SIMDD  , o7 * d1);
                MM_STOREU(imc+14*i+SIMDD*2, o7 * d2);
                MM_STOREU(imc+14*i+SIMDD*3, o7 * d3);
                // TODO: wait MM_STOREU finished before next assignment
        }
#else
        __m128d o7 = MM_SET1(0.14285714285714285714);
        __m128d s;
        __m128d d0[7];
        int i, j, k;
        for (i = 0; i < nroots; i++) {
                for (j = 0; j < 14/SIMDD; j++) {
                        d0[j] = 0;
                }
                for (j = 0; j < 14; j++) {
                        s = MM_SET1(im[j+14*i]);
                        for (k = 0; k < 14/SIMDD; ++k) {
                                d0[k] += s * MM_LOAD(COS_14_14+j*14+k*SIMDD);
                        }
                }
                for (j = 0; j < 14/SIMDD; j++) {
                        MM_STORE(imc+14*i+j*SIMDD, o7 * d0[j]);
                }
        }
#endif
}
